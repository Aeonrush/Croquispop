<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Croquispop</title>
    <link rel="stylesheet" type="text/css" href="./croquispop.css">
    <link rel="stylesheet" type="text/css"
          href="http://fonts.googleapis.com/earlyaccess/nanumgothic.css">
  </head>
  <body>
    <div id="brush-image-shelf">
      <div class="brush-image on" id="circle-brush"></div>
      <img src="./img/brush/b0.png" class="brush-image"></img>
      <img src="./img/brush/b1.png" class="brush-image"></img>
      <img src="./img/brush/b2.png" class="brush-image"></img>
      <img src="./img/brush/b3.png" class="brush-image"></img>
      <img src="./img/brush/b4.png" class="brush-image"></img>
      <img src="./img/brush/b5.png" class="brush-image"></img>
    </div>
    <br>
    <span>Preview: </span>
    <div id="canvas-area"></div>
    <br>
    <span>Simulate pressure: </span>
    <input id="simulate-pressure-checkbox" type="checkbox">
    <br>
    <span>Size: </span>
    <input id="size-slider" type="range" min="0" max="100">
    <br>
    <span>Flow: </span>
    <input id="flow-slider" type="range" min="0" max="100">
    <br>
    <span>Spacing: </span>
    <input id="spacing-slider" type="range" min="0" max="500">
    <br>
    <span>Angle: </span>
    <input id="angle-slider" type="range" min="0" max="360">
    <br>
    <span>Rotate to direction: </span>
    <input id="rotate-to-direction-checkbox" type="checkbox">
    <br>
    <span>Alpha threshold: </span>
    <input id="alpha-threshold-slider" type="range" min="1" max="255">
    <br>
    <span>Pointer: </span>
    <div id="pointer-container" style="display: inline;"></div>
    <script src="./croquis.js/croquis.js"></script>
    <script>
    // <![CDATA[
    var w = 300;
    var h = 150;

    var croquis = new Croquis();
    croquis.lockHistory(); //not using history
    croquis.setCanvasSize(w, h);
    croquis.addLayer();
    croquis.fillLayer('#fff');
    croquis.addLayer();
    croquis.selectLayer(1);
    var brush = new Croquis.Brush();
    brush.setSize(40);
    brush.setColor('#000');
    brush.setSpacing(0);
    croquis.setTool(brush);
    croquis.setToolStabilizeLevel(0); //not using stabilizer

    var croquisDOMElement = croquis.getDOMElement();
    var canvasArea = document.getElementById('canvas-area');
    canvasArea.appendChild(croquisDOMElement);

    var pointerContainer = document.getElementById('pointer-container');
    var sizeSlider = document.getElementById('size-slider');
    var flowSlider = document.getElementById('flow-slider');
    var spacingSlider = document.getElementById('spacing-slider');
    var angleSlider = document.getElementById('angle-slider');
    var rotateToDirectionCheckbox = document.getElementById('rotate-to-direction-checkbox');
    var alphaThresholdSlider = document.getElementById('alpha-threshold-slider');
    var simulatePressureCheckbox = document.getElementById('simulate-pressure-checkbox');

    sizeSlider.value = brush.getSize();
    flowSlider.value = brush.getFlow() * 100;
    spacingSlider.value = brush.getSpacing() * 100;
    angleSlider.value = brush.getAngle();
    alphaThresholdSlider.value = 0x20;
    simulatePressureCheckbox.checked = true;
    
    sizeSlider.onchange = function () {
      brush.setSize(sizeSlider.value);
      updatePointer();
      updatePreview();
    };
    flowSlider.onchange = function () {
      brush.setFlow(flowSlider.value * 0.01);
      updatePreview();
    };
    spacingSlider.onchange = function () {
      brush.setSpacing(spacingSlider.value * 0.01);
      updatePreview();
    };
    angleSlider.onchange = function () {
      brush.setAngle(angleSlider.value);
      updatePointer();
      updatePreview();
    };
    rotateToDirectionCheckbox.onchange = function () {
      brush.setRotateToDirection(rotateToDirectionCheckbox.checked);
      updatePreview();
    };
    alphaThresholdSlider.onchange = function () {
      updatePointer();
      updatePreview();
    };
    simulatePressureCheckbox.onchange = function () {
      updatePreview();
    };

    var circleBrush = document.getElementById('circle-brush');
    var brushImages = document.getElementsByClassName('brush-image');
    var currentBrush = circleBrush;
    Array.prototype.map.call(brushImages, function (brush) {
      brush.addEventListener('mousedown', brushImageMouseDown);
    });
    function brushImageMouseDown(e) {
      var image = e.currentTarget;
      image.className = 'brush-image on';
      currentBrush.className = 'brush-image';
      currentBrush = image;
      brush.setImage((image == circleBrush)? null : image);
      updatePointer();
      updatePreview();
    }

    function updatePointer() {
      var size = sizeSlider.value;
      var angle = angleSlider.value;
      var alphaThreshold = alphaThresholdSlider.value;
      var pointerImage = Croquis.createBrushPointer(
        brush.getImage(), size, angle, alphaThreshold, true);
      pointerImage.style.cssText = 'border: solid 1px';
      pointerContainer.innerHTML = '';
      pointerContainer.appendChild(pointerImage);
    }

    function updatePreview() {
      var deg360 = Math.PI * 2;
      var deg180 = Math.PI;
      var halfH = h >> 1;
      var padding = 50;
      var paddedWidth = w - padding * 2;
      var amplitude = halfH - padding;
      var pressure = simulatePressureCheckbox.checked ? 0 : 1;
      croquis.clearLayer();
      croquis.down(padding, halfH, pressure);
      for (var t = 0; t < 1; t += 0.01) {
        var horizontalPos = t * paddedWidth + padding;
        var verticalPos = Math.sin(deg360 * t) * amplitude + halfH;
        pressure = simulatePressureCheckbox.checked ?
                        Math.sin(deg180 * t) : 1;
        croquis.move(horizontalPos, verticalPos, pressure);
      }
      croquis.up(w - padding, halfH, pressure);
    }

    updatePointer();
    updatePreview();
    // ]]>
    </script>
  </body>
</html>